name: Deploy to Server (Advanced)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 30m
          script: |
            set -e  # Para execuÃ§Ã£o em caso de erro
            
            echo "=========================================="
            echo "ğŸš€ Iniciando deploy automÃ¡tico"
            echo "ğŸ“… Data: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="
            
            # VariÃ¡veis
            PROJECT_PATH="${{ secrets.PROJECT_PATH || '/home/ocidog/ava-senai' }}"
            BACKUP_DIR="$HOME/backups/ava-senai"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Navega para o diretÃ³rio do projeto
            echo "ğŸ“‚ Navegando para: $PROJECT_PATH"
            cd "$PROJECT_PATH" || exit 1
            
            # Backup antes do deploy (opcional)
            echo "ğŸ’¾ Criando backup..."
            mkdir -p "$BACKUP_DIR"
            tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" \
              --exclude='node_modules' \
              --exclude='.git' \
              --exclude='dist' \
              --exclude='build' \
              . || echo "âš ï¸  Backup falhou, continuando..."
            
            # Limpar backups antigos (manter Ãºltimos 5)
            ls -t "$BACKUP_DIR"/backup_*.tar.gz | tail -n +6 | xargs -r rm -f
            
            # Verificar branch atual
            CURRENT_BRANCH=$(git branch --show-current)
            echo "ğŸŒ¿ Branch atual: $CURRENT_BRANCH"
            
            if [ "$CURRENT_BRANCH" != "master" ]; then
              echo "âš ï¸  NÃ£o estÃ¡ na branch master, fazendo checkout..."
              git checkout master || exit 1
            fi
            
            # Stash de alteraÃ§Ãµes locais (se houver)
            if ! git diff-index --quiet HEAD --; then
              echo "ğŸ’¼ Salvando alteraÃ§Ãµes locais..."
              git stash save "Auto-stash before deploy $TIMESTAMP"
            fi
            
            # Pull das alteraÃ§Ãµes
            echo "ğŸ“¥ Baixando alteraÃ§Ãµes do repositÃ³rio..."
            git pull origin master || {
              echo "âŒ Erro ao fazer pull"
              exit 1
            }
            
            # Verificar se hÃ¡ alteraÃ§Ãµes
            COMMIT_HASH=$(git rev-parse --short HEAD)
            echo "ğŸ“ Commit atual: $COMMIT_HASH"
            
            # Parar containers
            echo "ğŸ›‘ Parando containers..."
            docker-compose down || echo "âš ï¸  Containers jÃ¡ estavam parados"
            
            # Rebuild e restart
            echo "ğŸ³ Reconstruindo e iniciando containers..."
            docker-compose up -d --build || {
              echo "âŒ Erro ao iniciar containers"
              echo "ğŸ”„ Tentando restaurar backup..."
              # Aqui vocÃª pode adicionar lÃ³gica de rollback se necessÃ¡rio
              exit 1
            }
            
            # Aguardar containers iniciarem
            echo "â³ Aguardando containers iniciarem..."
            sleep 10
            
            # Verificar status dos containers
            echo "ğŸ” Verificando status dos containers..."
            docker-compose ps
            
            # Limpar recursos nÃ£o utilizados
            echo "ğŸ§¹ Limpando recursos Docker nÃ£o utilizados..."
            docker system prune -f --volumes || echo "âš ï¸  Limpeza falhou"
            
            echo "=========================================="
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ğŸ“ Commit: $COMMIT_HASH"
            echo "â° Finalizado em: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="
      
      - name: ğŸ“Š Deploy Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deploy realizado com sucesso!"
          else
            echo "âŒ Deploy falhou!"
          fi
      
      # Opcional: Notificar em caso de falha
      - name: ğŸ”” Notify on Failure
        if: failure()
        run: |
          echo "Deploy falhou! Verifique os logs."
          # Aqui vocÃª pode adicionar notificaÃ§Ãµes (Discord, Slack, Email, etc)
